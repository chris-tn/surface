from surface.communication.ias import Quote

# TODO: add a failed verification


def test_decoding_response():
    response = {
        'ca': '-----BEGIN CERTIFICATE-----\nMIIFSzCCA7OgAwIBAgIJANEHdl0yo7CUMA0GCSqGSIb3DQEBCwUAMH4xCzAJBgNV\nBAYTAlVTMQswCQYDVQQIDAJDQTEUMBIGA1UEBwwLU2FudGEgQ2xhcmExGjAYBgNV\nBAoMEUludGVsIENvcnBvcmF0aW9uMTAwLgYDVQQDDCdJbnRlbCBTR1ggQXR0ZXN0\nYXRpb24gUmVwb3J0IFNpZ25pbmcgQ0EwIBcNMTYxMTE0MTUzNzMxWhgPMjA0OTEy\nMzEyMzU5NTlaMH4xCzAJBgNVBAYTAlVTMQswCQYDVQQIDAJDQTEUMBIGA1UEBwwL\nU2FudGEgQ2xhcmExGjAYBgNVBAoMEUludGVsIENvcnBvcmF0aW9uMTAwLgYDVQQD\nDCdJbnRlbCBTR1ggQXR0ZXN0YXRpb24gUmVwb3J0IFNpZ25pbmcgQ0EwggGiMA0G\nCSqGSIb3DQEBAQUAA4IBjwAwggGKAoIBgQCfPGR+tXc8u1EtJzLA10Feu1Wg+p7e\nLmSRmeaCHbkQ1TF3Nwl3RmpqXkeGzNLd69QUnWovYyVSndEMyYc3sHecGgfinEeh\nrgBJSEdsSJ9FpaFdesjsxqzGRa20PYdnnfWcCTvFoulpbFR4VBuXnnVLVzkUvlXT\nL/TAnd8nIZk0zZkFJ7P5LtePvykkar7LcSQO85wtcQe0R1Raf/sQ6wYKaKmFgCGe\nNpEJUmg4ktal4qgIAxk+QHUxQE42sxViN5mqglB0QJdUot/o9a/V/mMeH8KvOAiQ\nbyinkNndn+Bgk5sSV5DFgF0DffVqmVMblt5p3jPtImzBIH0QQrXJq39AT8cRwP5H\nafuVeLHcDsRp6hol4P+ZFIhu8mmbI1u0hH3W/0C2BuYXB5PC+5izFFh/nP0lc2Lf\n6rELO9LZdnOhpL1ExFOq9H/B8tPQ84T3Sgb4nAifDabNt/zu6MmCGo5U8lwEFtGM\nRoOaX4AS+909x00lYnmtwsDVWv9vBiJCXRsCAwEAAaOByTCBxjBgBgNVHR8EWTBX\nMFWgU6BRhk9odHRwOi8vdHJ1c3RlZHNlcnZpY2VzLmludGVsLmNvbS9jb250ZW50\nL0NSTC9TR1gvQXR0ZXN0YXRpb25SZXBvcnRTaWduaW5nQ0EuY3JsMB0GA1UdDgQW\nBBR4Q3t2pn680K9+QjfrNXw7hwFRPDAfBgNVHSMEGDAWgBR4Q3t2pn680K9+Qjfr\nNXw7hwFRPDAOBgNVHQ8BAf8EBAMCAQYwEgYDVR0TAQH/BAgwBgEB/wIBADANBgkq\nhkiG9w0BAQsFAAOCAYEAeF8tYMXICvQqeXYQITkV2oLJsp6J4JAqJabHWxYJHGir\nIEqucRiJSSx+HjIJEUVaj8E0QjEud6Y5lNmXlcjqRXaCPOqK0eGRz6hi+ripMtPZ\nsFNaBwLQVV905SDjAzDzNIDnrcnXyB4gcDFCvwDFKKgLRjOB/WAqgscDUoGq5ZVi\nzLUzTqiQPmULAQaB9c6Oti6snEFJiCQ67JLyW/E83/frzCmO5Ru6WjU4tmsmy8Ra\nUd4APK0wZTGtfPXU7w+IBdG5Ez0kE1qzxGQaL4gINJ1zMyleDnbuS8UicjJijvqA\n152Sq049ESDz+1rRGc2NVEqh1KaGXmtXvqxXcTB+Ljy5Bw2ke0v8iGngFBPqCTVB\n3op5KBG3RjbF6RRSzwzuWfL7QErNC8WEy5yDVARzTA5+xmBc388v9Dm21HGfcC8O\nDD+gT9sSpssq0ascmvH49MOgjt1yoysLtdCtJW/9FZpoOypaHx0R+mJTLwPXVMrv\nDaVzWh5aiEx+idkSGMnX\n-----END CERTIFICATE-----',
        'certificate': '-----BEGIN CERTIFICATE-----\nMIIEoTCCAwmgAwIBAgIJANEHdl0yo7CWMA0GCSqGSIb3DQEBCwUAMH4xCzAJBgNV\nBAYTAlVTMQswCQYDVQQIDAJDQTEUMBIGA1UEBwwLU2FudGEgQ2xhcmExGjAYBgNV\nBAoMEUludGVsIENvcnBvcmF0aW9uMTAwLgYDVQQDDCdJbnRlbCBTR1ggQXR0ZXN0\nYXRpb24gUmVwb3J0IFNpZ25pbmcgQ0EwHhcNMTYxMTIyMDkzNjU4WhcNMjYxMTIw\nMDkzNjU4WjB7MQswCQYDVQQGEwJVUzELMAkGA1UECAwCQ0ExFDASBgNVBAcMC1Nh\nbnRhIENsYXJhMRowGAYDVQQKDBFJbnRlbCBDb3Jwb3JhdGlvbjEtMCsGA1UEAwwk\nSW50ZWwgU0dYIEF0dGVzdGF0aW9uIFJlcG9ydCBTaWduaW5nMIIBIjANBgkqhkiG\n9w0BAQEFAAOCAQ8AMIIBCgKCAQEAqXot4OZuphR8nudFrAFiaGxxkgma/Es/BA+t\nbeCTUR106AL1ENcWA4FX3K+E9BBL0/7X5rj5nIgX/R/1ubhkKWw9gfqPG3KeAtId\ncv/uTO1yXv50vqaPvE1CRChvzdS/ZEBqQ5oVvLTPZ3VEicQjlytKgN9cLnxbwtuv\nLUK7eyRPfJW/ksddOzP8VBBniolYnRCD2jrMRZ8nBM2ZWYwnXnwYeOAHV+W9tOhA\nImwRwKF/95yAsVwd21ryHMJBcGH70qLagZ7Ttyt++qO/6+KAXJuKwZqjRlEtSEz8\ngZQeFfVYgcwSfo96oSMAzVr7V0L6HSDLRnpb6xxmbPdqNol4tQIDAQABo4GkMIGh\nMB8GA1UdIwQYMBaAFHhDe3amfrzQr35CN+s1fDuHAVE8MA4GA1UdDwEB/wQEAwIG\nwDAMBgNVHRMBAf8EAjAAMGAGA1UdHwRZMFcwVaBToFGGT2h0dHA6Ly90cnVzdGVk\nc2VydmljZXMuaW50ZWwuY29tL2NvbnRlbnQvQ1JML1NHWC9BdHRlc3RhdGlvblJl\ncG9ydFNpZ25pbmdDQS5jcmwwDQYJKoZIhvcNAQELBQADggGBAGcIthtcK9IVRz4r\nRq+ZKE+7k50/OxUsmW8aavOzKb0iCx07YQ9rzi5nU73tME2yGRLzhSViFs/LpFa9\nlpQL6JL1aQwmDR74TxYGBAIi5f4I5TJoCCEqRHz91kpG6Uvyn2tLmnIdJbPE4vYv\nWLrtXXfFBSSPD4Afn7+3/XUggAlc7oCTizOfbbtOFlYA4g5KcYgS1J2ZAeMQqbUd\nZseZCcaZZZn65tdqee8UXZlDvx0+NdO0LR+5pFy+juM0wWbu59MvzcmTXbjsi7HY\n6zd53Yq5K244fwFHRQ8eOB0IWB+4PfM7FeAApZvlfqlKOlLcZL2uyVmzRkyR5yW7\n2uo9mehX44CiPJ2fse9Y6eQtcfEhMPkmHXI01sN+KwPbpA39+xOsStjhP9N1Y1a2\ntQAVo+yVgLgV2Hws73Fc0o3wC78qPEA+v2aRs/Be3ZFDgDyghc/1fgU+7C+P6kbq\nd4poyb6IW8KCJbxfMJvkordNOgOUUxndPHEi/tb/U7uLjLOgPA==\n-----END CERTIFICATE-----',
        'report': {
            'id': '327772120793081908218831855377682106989',
            'timestamp': '2018-06-27T12:42:30.022655',
            'isvEnclaveQuoteStatus': 'GROUP_OUT_OF_DATE',
            'platformInfoBlob': '1502006504000100000505020401010000000000000000000007000006000000020000000000000ADA05003BA36C567E5E1EFE15B0B8649E39648D3E782635C543E82202369601CCD80B3C2442B39F677F96E143C3D4F34C3349641397DB419254BB72D25D4F71993D',
            'isvEnclaveQuoteBody': 'AgAAANoKAAAHAAYAAAAAABYB+Vw5ueowf+qruQGtw+7d6cgYupo5aV1se5h5PNRtBAT/////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAAAAAAAAAHAAAAAAAAAIy+zzPDwoSqL0nl7GbotOJDsPArAtCYDfi2YSqPF7XbAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACD1xnnferKFHD2uvYqTXdDA8iZ22kCD5xw7h38CMfOngAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACnsK84VyqF+Yfs+ycO6Lqy2LEdJafU0CWtjnsUk1mwCdTfswKDSihWHf9M934PbD39bgRSQyOCzovuNKh16zun'
            },
        'signature': '7d683b8f2f32294b777d8e28584cea03e68f32a3cf746d9c0ebeb5e0b1e8a124df601c502dbffcddffa91153ac594e34dc22997d3957543f04c7fbc45ad32a40f81705dfd6e39fb09406fc7bd5c27c480b432d49b9201c9cd69a5e823472a9812f27aba10c820d97d93f3f983daf46d1f859d13d0157a46c30805268100ed57fa730273f438cc3fb65fe3c73e2514af0db7627bc4de7d84347a12b7ae68767f4b4405b89cc97ed2cc60d145ab319033af49452e0f5b67c0965de06aaa2e365850f69d8735508305200a798dae3d2e4b9a3e16877943edfc045d269865adfa36d3b8cc9903fe37f39295de1a5bb74b8170c44ecb8c644f760e21c85f0bf5decb9',
        'validate': 'True'
    }
    q = Quote(response_report=response)
    assert q.report_body.report_data.hex() == 'a7b0af38572a85f987ecfb270ee8bab2d8b11d25a7d4d025ad8e7b149359b009d4dfb302834a28561dff4cf77e0f6c3dfd6e0452432382ce8bee34a875eb3ba7'


def test_decode_isvquote_only():
    isv = 'AgAAANoKAAAHAAYAAAAAABYB+Vw5ueowf+qruQGtw+7d6cgYupo5aV1se5h5PNRtBAT/////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAAAAAAAAAHAAAAAAAAAIy+zzPDwoSqL0nl7GbotOJDsPArAtCYDfi2YSqPF7XbAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACD1xnnferKFHD2uvYqTXdDA8iZ22kCD5xw7h38CMfOngAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACnsK84VyqF+Yfs+ycO6Lqy2LEdJafU0CWtjnsUk1mwCdTfswKDSihWHf9M934PbD39bgRSQyOCzovuNKh16zun'
    q = Quote(quote=isv)
    assert q.report_body.report_data.hex() == 'a7b0af38572a85f987ecfb270ee8bab2d8b11d25a7d4d025ad8e7b149359b009d4dfb302834a28561dff4cf77e0f6c3dfd6e0452432382ce8bee34a875eb3ba7'


def test_enigma_proxy_pubkey():
    quote = 'AgAAANoKAAAHAAYAAAAAABYB+Vw5ueowf+qruQGtw+7d6cgYupo5aV1se5h5PNRtBAT/////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAAAAAAAAAHAAAAAAAAAIy+zzPDwoSqL0nl7GbotOJDsPArAtCYDfi2YSqPF7XbAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACD1xnnferKFHD2uvYqTXdDA8iZ22kCD5xw7h38CMfOngAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACnsK84VyqF+Yfs+ycO6Lqy2LEdJafU0CWtjnsUk1mwCdTfswKDSihWHf9M934PbD39bgRSQyOCzovuNKh16zunqAIAAGRhMcd1bM8NHAwUW0Rf8digss12MvJ4BMb71D3Rq5TCI4eGW5CB+cchZr07uxqIMwrXo1UVt1Q6uRycFxgMAAXYVV5wTzfby0dqt/k9QyLbAPhJYx2p8+SMgElQJOSSwQ22K9jTfct5Gp5DQPwJA5zOpAYiV50hLFockebH0ACC0kY9cRq7uWRf6TDHaOXVBGrS7fx/O73wjd6uzbPK2k0vtjnZMXICF+eAGdfOEattkcvw7qkZYh/51dDIIST0UJc2ekSAuzlWdmWqFJZ3u1MPgdXxivlDFIIpqRnJD3KlVq7fwocchg5nMgR3BddrpVTmpQgPzrobtFd9s0Sn/XdfsmnuMKOolTgnh9lWBUK4nXcbxiqUWDxzWrJbOPASgZt4Wx9Cad4f3lzIr2gBAAA74iSJT6R/DDyZ4CJKCi+iXUDnumEaaHBViHaTrJD9qCh1fEdUFdRdFeIj6tOp6/w0txSzZ3wLNH8P5Ypw6DpkvJohHim2+5r7Kx5quD8uFVP6esv3eL08Es9bcHm3msEW5jb6N0dsAHJ9JCxUql8V/w1857uwwOfQ17cx5KB7lTfPdZc5YpxP1Albu0dbHHUhlaGUCtSik5ILLF4GcbVPckWtNXP5JVlxO1gpZCpWMTByXjjhaWH3C3HLawZei5s0RSKtiwJFo/sJ6T2gdH4S9EI0iqF5hmtuLPSd4CPZgCon8U2xoQFlVWCxrCM9yzhmE/Q0Ro+4OnQEyNlc+h6pq/sxfroDYDH4cf+0vasFEJq5N8iqMQUbO0IFFhQJkzvpLY4/Sa2kuOet2HdG4Cg9rmuZnYWAcfOyuiaPUXr9Cnk2DmlpQ/gpypeRGjCTWuEv5V9IsJUAXNbNKDjsUK/N69vWlcoQjpbSGJX7mF9QOPqZCcnYlMRU'
    a = Quote.from_enigma_proxy(quote)
    assert a.report_body.report_data.hex() == 'a7b0af38572a85f987ecfb270ee8bab2d8b11d25a7d4d025ad8e7b149359b009d4dfb302834a28561dff4cf77e0f6c3dfd6e0452432382ce8bee34a875eb3ba7'
